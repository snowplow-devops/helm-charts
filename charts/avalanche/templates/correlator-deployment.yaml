{{- if .Values.correlator.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "avalanche.fullname" . }}-correlator
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "snowplow.labels" . | nindent 4 }}
    app.kubernetes.io/component: correlation
spec:
  replicas: {{ .Values.correlator.replicas }}
  selector:
    matchLabels:
      {{- include "avalanche.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: correlation
  template:
    metadata:
      labels:
        {{- include "snowplow.labels" . | nindent 8 }}
        {{- include "avalanche.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: correlation
    spec:
      {{- if .Values.cloudserviceaccount.deploy }}
      serviceAccount: {{ .Values.cloudserviceaccount.name }}
      serviceAccountName: {{ .Values.cloudserviceaccount.name }}
      {{- else }}
      serviceAccount: ""
      serviceAccountName: ""
      {{- end }}
      automountServiceAccountToken: true
      imagePullSecrets:
      - name: {{ .Values.dockerconfigjson.name }}
      containers:
        - name: correlator
          image: {{ include "avalanche.image" (dict "images" .Values.images "image" .Values.correlator.image) }}
          imagePullPolicy: {{ .Values.images.pullPolicy }}
          args:
            - "correlator"
            - "--config=/configs/correlator.yaml"
            - "--nats-url={{ include "avalanche.natsUrl" . }}"
            - "--component-id={{ .Values.correlator.componentId }}"
          # Note: Correlator in standalone/container mode communicates via NATS only
          # No HTTP API port is exposed
          env:
            - name: AVALANCHE_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "avalanche.fullname" . }}-config
                  key: log_level
            - name: AVALANCHE_NATS_URL
              value: {{ include "avalanche.natsUrl" . | quote }}
            {{- if .Values.correlator.metricsWriteIntervalSeconds }}
            - name: AVALANCHE_METRICS_WRITE_INTERVAL_SECONDS
              value: {{ .Values.correlator.metricsWriteIntervalSeconds | quote }}
            {{- end }}
            {{- include "avalanche.databaseEnv" . | nindent 12 }}
            {{- include "avalanche.awsEnv" . | nindent 12 }}
          volumeMounts:
            - name: config
              mountPath: /configs
              readOnly: true
            - name: data
              mountPath: /data/correlator
          # Liveness probe - check process is running and can reach NATS
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - wget -q --spider http://{{ include "avalanche.fullname" . }}-nats:8222/healthz
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          # Readiness probe - component is ready when NATS is reachable
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - wget -q --spider http://{{ include "avalanche.fullname" . }}-nats:8222/healthz
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
          resources:
            {{- toYaml .Values.correlator.resources | nindent 12 }}
      volumes:
        - name: config
          configMap:
            name: {{ include "avalanche.fullname" . }}-config
        - name: data
          emptyDir: {}
      restartPolicy: Always
{{- end }}
